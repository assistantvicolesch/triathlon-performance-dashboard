<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Triathlon Hamburg 2026 - Live Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        body { background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%); min-height: 100vh; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 1.5rem; }
        .glow { box-shadow: 0 0 40px rgba(59, 130, 246, 0.1); }
        .btn-action { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-action:hover { transform: translateY(-1px); filter: brightness(1.2); }
        .metric-card { position: relative; overflow: hidden; }
        .metric-card::after { content: ''; position: absolute; top: 0; right: 0; width: 64px; height: 64px; background: linear-gradient(135deg, transparent 50%, rgba(255,255,255,0.03) 50%); }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .activity-card:hover { transform: translateY(-2px); transition: all 0.2s ease; }
        .stat-value { font-variant-numeric: tabular-nums; }
        .loading-skeleton { background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }
        .tag-active { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); }
        .tag-inactive { background: rgba(30, 41, 59, 0.5); color: #475569; border: 1px solid rgba(255, 255, 255, 0.05); }
    </style>
</head>
<body class="text-slate-100 p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="glass rounded-2xl p-6 mb-6 glow">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <div class="flex items-center gap-3">
                        <div class="w-2.5 h-2.5 bg-green-500 rounded-full pulse" id="status-indicator"></div>
                        <span class="text-[10px] text-slate-500 uppercase tracking-[0.2em] font-bold">System Online</span>
                        <div id="consistency-badge" class="ml-4 px-3 py-1 bg-green-500/10 text-green-400 rounded-full border border-green-500/20 text-[10px] font-black uppercase tracking-widest hidden">
                            Score: <span id="consistency-val">0%</span>
                        </div>
                        <div id="weather-display" class="hidden md:flex items-center gap-2 ml-4 px-4 py-1.5 bg-slate-900/50 rounded-full border border-white/5">
                            <!-- Weather injected here -->
                        </div>
                    </div>
                    <h1 class="text-4xl md:text-5xl font-black mt-3 tracking-tight bg-gradient-to-br from-white via-blue-100 to-slate-500 bg-clip-text text-transparent">
                        HAMBURG 2026
                    </h1>
                    <p class="text-slate-500 text-sm mt-1 font-medium tracking-wide">Elite Performance & Logistics Dashboard</p>
                </div>
                <div class="text-right">
                    <div class="text-5xl font-bold stat-value text-blue-400" id="countdown">--</div>
                    <div class="text-xs text-slate-500 uppercase tracking-widest mt-1">Days Until Race</div>
                    <div class="text-[10px] bg-blue-500/20 text-blue-400 px-3 py-1 rounded-full inline-block mt-3 font-black uppercase tracking-widest border border-blue-500/20" id="training-phase">---</div>
                    <div class="text-xs text-slate-600 mt-2" id="last-updated">Loading...</div>
                </div>
            </div>
        </header>

        <!-- Prediction Section -->
        <div class="glass p-6 mb-6 border-l-4 border-yellow-500/50">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-[10px] text-slate-500 uppercase tracking-[0.2em] font-black">Performance Forecast vs Reality</h2>
                <div class="flex gap-2">
                    <div class="w-2 h-2 rounded-full bg-blue-500"></div>
                    <div class="w-2 h-2 rounded-full bg-slate-700"></div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8" id="prediction-metrics">
                <!-- Data will be inserted here -->
            </div>
        </div>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
            <div class="glass p-6 metric-card">
                <div class="flex justify-between items-start mb-6">
                    <span class="text-[10px] text-slate-500 uppercase tracking-[0.2em] font-black">Weekly Distance</span>
                    <div class="w-8 h-8 rounded-lg bg-blue-500/10 flex items-center justify-center">
                        <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                    </div>
                </div>
                <div class="flex items-baseline gap-1">
                    <div class="text-5xl font-black tracking-tighter stat-value text-white" id="weekly-distance">--</div>
                    <span class="text-slate-500 font-bold text-sm">km</span>
                </div>
                <div class="mt-6 h-1 w-full bg-slate-900 rounded-full overflow-hidden">
                    <div id="distance-progress" class="h-full bg-gradient-to-r from-blue-600 to-blue-400 transition-all duration-1000" style="width: 0%"></div>
                </div>
                <div class="flex justify-between mt-3">
                    <span class="text-[9px] text-slate-600 uppercase font-bold tracking-wider">Progress</span>
                    <span class="text-[9px] text-slate-500 uppercase font-black" id="distance-target">Goal: 60km</span>
                </div>
            </div>
            <div class="glass p-6 metric-card">
                <div class="flex justify-between items-start mb-6">
                    <span class="text-[10px] text-slate-500 uppercase tracking-[0.2em] font-black">Training Time</span>
                    <div class="w-8 h-8 rounded-lg bg-purple-500/10 flex items-center justify-center">
                        <svg class="w-4 h-4 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                </div>
                <div class="flex items-baseline gap-1">
                    <div class="text-5xl font-black tracking-tighter stat-value text-white" id="weekly-time">--</div>
                    <span class="text-slate-500 font-bold text-sm">hrs</span>
                </div>
                <div class="mt-6 h-1 w-full bg-slate-900 rounded-full overflow-hidden">
                    <div id="time-progress" class="h-full bg-gradient-to-r from-purple-600 to-purple-400 transition-all duration-1000" style="width: 0%"></div>
                </div>
                <div class="flex justify-between mt-3">
                    <span class="text-[9px] text-slate-600 uppercase font-bold tracking-wider">Efficiency</span>
                    <span class="text-[9px] text-slate-500 uppercase font-black" id="time-target">Goal: 10h</span>
                </div>
            </div>
            <div class="glass p-6 metric-card">
                <div class="flex justify-between items-start mb-6">
                    <span class="text-[10px] text-slate-500 uppercase tracking-[0.2em] font-black">Sessions</span>
                    <div class="w-8 h-8 rounded-lg bg-green-500/10 flex items-center justify-center">
                        <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                    </div>
                </div>
                <div class="flex items-baseline gap-1">
                    <div class="text-5xl font-black tracking-tighter stat-value text-white" id="activity-count">--</div>
                    <span class="text-slate-500 font-bold text-sm">count</span>
                </div>
                <div class="mt-6 h-1 w-full bg-slate-900 rounded-full overflow-hidden">
                    <div id="activity-progress" class="h-full bg-gradient-to-r from-green-600 to-green-400 transition-all duration-1000" style="width: 0%"></div>
                </div>
                <div class="flex justify-between mt-3">
                    <span class="text-[9px] text-slate-600 uppercase font-bold tracking-wider">Consistency</span>
                    <span class="text-[9px] text-slate-500 uppercase font-black" id="activity-target">Goal: 7</span>
                </div>
            </div>
            <div class="glass p-6 metric-card">
                <div class="flex justify-between items-start mb-6">
                    <span class="text-[10px] text-slate-500 uppercase tracking-[0.2em] font-black">Gym Load</span>
                    <div class="w-8 h-8 rounded-lg bg-orange-500/10 flex items-center justify-center">
                        <svg class="w-4 h-4 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064"></path></svg>
                    </div>
                </div>
                <div class="flex items-baseline gap-1">
                    <div class="text-5xl font-black tracking-tighter stat-value text-white" id="gym-sessions">--</div>
                    <span class="text-slate-500 font-bold text-sm">units</span>
                </div>
                <div class="mt-6 h-1 w-full bg-slate-900 rounded-full overflow-hidden">
                    <div id="gym-progress" class="h-full bg-gradient-to-r from-orange-600 to-orange-400 transition-all duration-1000" style="width: 0%"></div>
                </div>
                <div class="flex justify-between mt-3">
                    <span class="text-[9px] text-slate-600 uppercase font-bold tracking-wider">Recovery</span>
                    <span class="text-[9px] text-slate-500 uppercase font-black" id="gym-target">Goal: 3</span>
                </div>
            </div>
            <div class="glass p-6 metric-card">
                <div class="flex justify-between items-start mb-6">
                    <span class="text-[10px] text-slate-500 uppercase tracking-[0.2em] font-black">Daily Fueling</span>
                    <div class="w-8 h-8 rounded-lg bg-rose-500/10 flex items-center justify-center">
                        <svg class="w-4 h-4 text-rose-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.99 7.99 0 0120 13a7.98 7.98 0 01-2.343 5.657z"></path></svg>
                    </div>
                </div>
                <div class="flex items-baseline gap-1">
                    <div class="text-5xl font-black tracking-tighter stat-value text-white" id="daily-energy">--</div>
                    <span class="text-slate-500 font-bold text-sm">kcal</span>
                </div>
                <div class="mt-6 flex gap-1 h-1 w-full bg-slate-900 rounded-full overflow-hidden">
                    <div id="carb-bar" class="h-full bg-blue-500 transition-all duration-1000" style="width: 0%"></div>
                    <div id="pro-bar" class="h-full bg-rose-500 transition-all duration-1000" style="width: 0%"></div>
                    <div id="fat-bar" class="h-full bg-yellow-500 transition-all duration-1000" style="width: 0%"></div>
                </div>
                <div class="flex justify-between mt-3">
                    <span class="text-[9px] text-slate-600 uppercase font-bold tracking-wider">P / C / F</span>
                    <span class="text-[9px] text-slate-500 uppercase font-black" id="macro-summary">-- / -- / --</span>
                </div>
            </div>
        </div>

        <!-- Charts and Details Row -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
            <div class="glass rounded-xl p-5 glow lg:col-span-2">
                <h2 class="text-[10px] text-slate-500 uppercase tracking-[0.2em] font-black mb-6">Weekly Activity Breakdown</h2>
                <div class="h-64">
                    <canvas id="activity-chart"></canvas>
                </div>
            </div>
            <div class="glass p-6 metric-card">
                <h2 class="text-[10px] text-slate-500 uppercase tracking-[0.2em] font-black mb-6">Load History</h2>
                <div class="h-64">
                    <canvas id="load-history-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Training Plan -->
        <div class="glass p-6 mb-6">
            <h2 class="text-[10px] text-slate-500 uppercase tracking-[0.2em] font-black mb-6">Strategy & Cycle Structure</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8" id="plan-cycles">
                <!-- Macrociclo and Mesociclo will be inserted here -->
            </div>
            <div class="flex items-center gap-4 mb-6">
                <h3 class="text-[10px] text-slate-500 uppercase tracking-[0.2em] font-black">Weekly Execution</h3>
                <div class="h-px flex-1 bg-white/5"></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-4 lg:grid-cols-7 gap-4" id="weekly-plan">
                <!-- Generated by JS -->
            </div>
        </div>

        <!-- Recent Activities -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
            <div class="glass p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-[10px] text-slate-500 uppercase tracking-[0.2em] font-black">Equipment Status</h2>
                    <span class="text-[9px] text-slate-600 uppercase font-bold tracking-wider">Active Tech</span>
                </div>
                <div id="equipment-list" class="space-y-3">
                    <div class="flex items-center justify-between p-3 rounded-xl tag-inactive">
                        <span class="text-[11px] font-bold">Wahoo KICKR</span>
                        <span class="text-[9px] font-black uppercase tracking-widest px-2 py-0.5 rounded bg-slate-800">Standby</span>
                    </div>
                    <div class="flex items-center justify-between p-3 rounded-xl tag-inactive">
                        <span class="text-[11px] font-bold">Garmin Forerunner 955</span>
                        <span class="text-[9px] font-black uppercase tracking-widest px-2 py-0.5 rounded bg-slate-800">Standby</span>
                    </div>
                    <div class="flex items-center justify-between p-3 rounded-xl tag-inactive">
                        <span class="text-[11px] font-bold">Coros Heart Rate</span>
                        <span class="text-[9px] font-black uppercase tracking-widest px-2 py-0.5 rounded bg-slate-800">Standby</span>
                    </div>
                    <div class="flex items-center justify-between p-3 rounded-xl tag-inactive">
                        <span class="text-[11px] font-bold">Form Smart Goggles</span>
                        <span class="text-[9px] font-black uppercase tracking-widest px-2 py-0.5 rounded bg-slate-800">Standby</span>
                    </div>
                </div>
            </div>
            <div class="glass p-6">
                <h2 class="text-[10px] text-slate-500 uppercase tracking-[0.2em] font-black mb-6">Strava Streams</h2>
                <div id="strava-activities" class="space-y-3 max-h-96 overflow-y-auto pr-2 custom-scrollbar"></div>
            </div>
            <div class="glass p-6">
                <h2 class="text-[10px] text-slate-500 uppercase tracking-[0.2em] font-black mb-6">Hevy Workouts</h2>
                <div id="hevy-workouts" class="space-y-3 max-h-96 overflow-y-auto pr-2 custom-scrollbar"></div>
            </div>
        </div>

        <footer class="text-center text-slate-600 text-xs uppercase tracking-widest py-4">
            Clawd Performance System v2.1 | Training Plan & Forecast Integrated
        </footer>
    </div>

    <script>
        const RACE_DATE = new Date('2026-07-11T09:00:00');
        let activityChart, loadHistoryChart;

        function getSpanishDay() {
            const days = ['Domingo', 'Lunes', 'Martes', 'MiÃ©rcoles', 'Jueves', 'Viernes', 'SÃ¡bado'];
            return days[new Date().getDay()];
        }

        function updateCountdown() {
            const now = new Date();
            const diff = RACE_DATE - now;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            document.getElementById('countdown').textContent = days;

            const weeks = days / 7;
            let phase = '';
            if (weeks > 24) phase = 'Pre-Season';
            else if (weeks > 16) phase = 'Base Phase';
            else if (weeks > 8) phase = 'Build Phase';
            else if (weeks > 4) phase = 'Peak Phase';
            else if (weeks > 1) phase = 'Taper Phase';
            else phase = 'Race Week';
            
            document.getElementById('training-phase').textContent = phase;
        }

        function renderStravaList(activities) {
            const container = document.getElementById('strava-activities');
            container.innerHTML = activities.map(a => `
                <div class="glass bg-slate-900/40 p-4 rounded-xl flex justify-between items-center activity-card border border-white/5">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-full bg-blue-500/10 flex items-center justify-center text-blue-400">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                        </div>
                        <div>
                            <div class="text-sm font-bold text-slate-100">${a.name}</div>
                            <div class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">${new Date(a.start_date).toLocaleDateString()} â€¢ ${a.type}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-black text-blue-400">${(a.distance/1000).toFixed(2)} <span class="text-[10px] text-slate-600">KM</span></div>
                        <div class="text-[10px] text-slate-500 font-bold">${Math.floor(a.moving_time/60)} MIN</div>
                    </div>
                </div>
            `).join('');
        }

        function renderHevyList(workouts) {
            const container = document.getElementById('hevy-workouts');
            container.innerHTML = workouts.map(w => `
                <div class="glass bg-slate-900/40 p-4 rounded-xl flex justify-between items-center activity-card border border-white/5">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-full bg-orange-500/10 flex items-center justify-center text-orange-400">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064"></path></svg>
                        </div>
                        <div>
                            <div class="text-sm font-bold text-slate-100">${w.title}</div>
                            <div class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">${new Date(w.start_time).toLocaleDateString()}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-black text-orange-400">${w.exercises.length} <span class="text-[10px] text-slate-600">EX</span></div>
                        <div class="text-[10px] text-slate-500 font-bold">${Math.floor((new Date(w.end_time) - new Date(w.start_time))/60000)} MIN</div>
                    </div>
                </div>
            `).join('');
        }

        function renderTrainingData(markdown, healthData) {
            const weeklyPlanContainer = document.getElementById('weekly-plan');
            const cyclesContainer = document.getElementById('plan-cycles');
            const predictionContainer = document.getElementById('prediction-metrics');
            
            const lines = markdown.split('\n');
            let currentSection = '';
            let macroContent = [];
            let mesoContent = [];
            let weeklyTable = [];
            let predictionContent = [];

            let totalPlanned = 0;
            let totalDone = 0;

            lines.forEach(line => {
                const trimmed = line.trim();
                if (trimmed.includes('## ðŸ“… Plan Global')) currentSection = 'macro';
                else if (trimmed.includes('## ðŸ—“ï¸ Plan Mensual')) currentSection = 'meso';
                else if (trimmed.includes('## âš¡ Plan Semanal')) currentSection = 'weekly';
                else if (trimmed.includes('## ðŸ“ˆ PrevisiÃ³n')) currentSection = 'prediction';
                
                if (currentSection === 'macro' && trimmed.startsWith('- **')) macroContent.push(trimmed);
                if (currentSection === 'meso' && (trimmed.startsWith('- **') || trimmed.startsWith('â€¢ ') || trimmed.startsWith('  - '))) mesoContent.push(trimmed);
                if (currentSection === 'weekly' && trimmed.startsWith('| **')) {
                    weeklyTable.push(trimmed);
                    const parts = trimmed.split('|').filter(p => p.trim() !== '');
                    const primary = parts[1]?.trim() || '';
                    const secondary = parts[2]?.trim() || '';
                    const notes = parts[3]?.trim() || '';
                    
                    if (primary && !primary.includes('SKIPPED') && !primary.includes('Descanso')) totalPlanned++;
                    if (secondary && !secondary.includes('SKIPPED') && !secondary.includes('Descanso') && secondary !== '-') totalPlanned++;
                    
                    const hechoCount = (notes.match(/hecho/gi) || []).length;
                    totalDone += hechoCount;
                }
                if (currentSection === 'prediction' && trimmed.startsWith('- **')) predictionContent.push(trimmed);
            });

            if (totalPlanned > 0) {
                const score = Math.min(Math.round((totalDone / totalPlanned) * 100), 100);
                const badge = document.getElementById('consistency-badge');
                document.getElementById('consistency-val').textContent = score + '%';
                badge.classList.remove('hidden');
                
                // Color coding based on completion
                badge.className = "ml-4 px-3 py-1 rounded-full border text-[10px] font-black uppercase tracking-widest";
                if (score < 50) badge.className += " bg-red-500/10 text-red-400 border-red-500/20";
                else if (score < 80) badge.className += " bg-yellow-500/10 text-yellow-400 border-yellow-500/20";
                else badge.className += " bg-green-500/10 text-green-400 border-green-500/20";
            }

            cyclesContainer.innerHTML = `
                <div class="bg-slate-900/40 rounded-2xl p-6 border border-white/5">
                    <h4 class="text-[10px] text-blue-400 uppercase font-black mb-4 tracking-[0.2em]">Global Macrociclo</h4>
                    <ul class="text-sm space-y-3 text-slate-400">
                        ${macroContent.map(item => `<li class="flex gap-2">
                            <span class="text-blue-500/50">â€¢</span>
                            <span>${item.replace(/- \*\*(.*?)\*\*: /g, '<b class="text-slate-100">$1:</b> ').replace(/^- /,'')}</span>
                        </li>`).join('')}
                    </ul>
                </div>
                <div class="bg-slate-900/40 rounded-2xl p-6 border border-white/5">
                    <h4 class="text-[10px] text-purple-400 uppercase font-black mb-4 tracking-[0.2em]">Monthly Mesociclo</h4>
                    <ul class="text-sm space-y-3 text-slate-400">
                        ${mesoContent.map(item => `<li class="flex gap-2">
                            <span class="text-purple-500/50">â€¢</span>
                            <span>${item.replace(/^  - /g, 'â€¢ ').replace(/^- /g, 'â€¢ ').replace(/\*\*(.*?)\*\*: /g, '<b class="text-slate-100">$1:</b> ')}</span>
                        </li>`).join('')}
                    </ul>
                </div>
            `;

            const currentSpanishDay = getSpanishDay();

            weeklyPlanContainer.innerHTML = weeklyTable.map(row => {
                const parts = row.split('|').filter(p => p.trim() !== '');
                const day = parts[0].trim().replace(/\*\*/g, '');
                const session = parts[1]?.trim() || '';
                const notes = parts[3]?.trim() || '';
                const isHecho = notes.toLowerCase().includes('hecho');
                const isToday = day.toLowerCase() === currentSpanishDay.toLowerCase();

                return `
                    <div class="glass p-4 border-l-2 ${isToday ? 'border-yellow-400 bg-yellow-400/5 ring-1 ring-yellow-400/20' : isHecho ? 'border-green-500 bg-green-500/5' : 'border-blue-500/30'} ${isToday ? 'scale-105 z-10 shadow-2xl' : ''} transition-all duration-500">
                        <div class="flex justify-between items-start mb-3">
                            <div class="text-[9px] uppercase font-black tracking-widest ${isToday ? 'text-yellow-400' : 'text-slate-600'}">${day}</div>
                            ${isHecho ? '<div class="w-2 h-2 rounded-full bg-green-500"></div>' : ''}
                        </div>
                        <div class="text-[11px] font-bold leading-tight ${isToday ? 'text-white' : 'text-slate-200'}">${session.replace(/\*\*/g, '')}</div>
                        <div class="text-[9px] text-slate-500 mt-3 font-medium leading-relaxed">${notes}</div>
                    </div>
                `;
            }).join('');

            // Use dynamic healthData if available, otherwise parse from markdown
            const metrics = [
                { label: 'VO2 Max', target: '42', real: healthData?.vo2max || '---', color: 'text-blue-400' },
                { label: 'Weight', target: '74kg', real: healthData?.weight ? `${healthData.weight}kg` : '---', color: 'text-green-400' },
                { label: 'Threshold Pace', target: '4:30', real: healthData?.threshold || '---', color: 'text-yellow-400' }
            ];

            predictionContainer.innerHTML = metrics.map(m => `
                <div class="flex flex-col relative">
                    <span class="text-[10px] text-slate-500 uppercase font-black tracking-widest mb-2">${m.label}</span>
                    <div class="flex items-baseline gap-3">
                        <span class="text-4xl font-black ${m.color} tracking-tighter">${m.real}</span>
                        <div class="flex flex-col">
                            <span class="text-[9px] text-slate-600 uppercase font-bold">Target</span>
                            <span class="text-xs text-slate-400 font-black">${m.target}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function refreshData() {
            try {
                const response = await fetch('/api/dashboard');
                const data = await response.json();
                
                // Fetch load stats separately
                const loadResponse = await fetch('/api/load_stats.json');
                const loadData = await loadResponse.json();
                
                document.getElementById('weekly-distance').textContent = data.strava.weeklyStats.totalDistance.toFixed(1);
                document.getElementById('weekly-time').textContent = data.strava.weeklyStats.totalTime.toFixed(1);
                document.getElementById('activity-count').textContent = data.strava.weeklyStats.activityCount;
                
                const gymCount = data.hevy.workouts.filter(w => new Date(w.start_time) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)).length;
                document.getElementById('gym-sessions').textContent = gymCount;

                // Update Progress Bars
                const goals = { distance: 60, time: 10, activities: 7, gym: 3 };
                const stats = {
                    distance: data.strava.weeklyStats.totalDistance,
                    time: data.strava.weeklyStats.totalTime,
                    activities: data.strava.weeklyStats.activityCount,
                    gym: gymCount
                };

                Object.keys(goals).forEach(key => {
                    const progress = Math.min((stats[key] / goals[key]) * 100, 100);
                    const bar = document.getElementById(`${key}-progress`);
                    if (bar) bar.style.width = `${progress}%`;
                });

                // Update Training Time card with load status
                if (loadData.load_status) {
                    const timeCard = document.getElementById('weekly-time').parentElement;
                    const statusTag = timeCard.querySelector('span:last-child');
                    if (statusTag) {
                        statusTag.textContent = loadData.load_status + ' Load';
                        statusTag.className = `text-[10px] px-2 py-0.5 rounded ${loadData.load_status === 'High' ? 'bg-red-500/20 text-red-400' : 'bg-green-500/20 text-green-400'}`;
                    }
                }

                // Update Nutrition Card
                if (loadData.nutrition) {
                    const n = loadData.nutrition;
                    document.getElementById('daily-energy').textContent = Math.round(n.energy);
                    document.getElementById('macro-summary').textContent = `${Math.round(n.protein)}g / ${Math.round(n.carbs)}g / ${Math.round(n.fat)}g`;
                    
                    const totalGrams = parseFloat(n.protein) + parseFloat(n.carbs) + parseFloat(n.fat);
                    if (totalGrams > 0) {
                        document.getElementById('carb-bar').style.width = `${(parseFloat(n.carbs) / totalGrams) * 100}%`;
                        document.getElementById('pro-bar').style.width = `${(parseFloat(n.protein) / totalGrams) * 100}%`;
                        document.getElementById('fat-bar').style.width = `${(parseFloat(n.fat) / totalGrams) * 100}%`;
                    }
                }

                renderStravaList(data.strava.activities);
                renderHevyList(data.hevy.workouts);
                
                if (data.strava.activities && data.strava.activities.length > 0) {
                    const lastActivity = data.strava.activities[0];
                    const diffMinutes = (new Date() - new Date(lastActivity.start_date)) / 60000;
                    if (diffMinutes < 180) { // Active in last 3 hours
                        const gear = lastActivity.device_name || (lastActivity.type === 'Ride' ? 'Wahoo KICKR' : 'Garmin Forerunner 955');
                        const list = document.getElementById('equipment-list');
                        const items = list.querySelectorAll('div');
                        items.forEach(item => {
                            if (item.textContent.includes(gear)) {
                                item.className = 'flex items-center justify-between p-3 rounded-xl tag-active';
                                item.querySelector('span:last-child').textContent = 'Live / Sync';
                            }
                        });
                    }
                }

                if (data.trainingPlan) {
                    renderTrainingData(data.trainingPlan, data.healthData);
                }

                if (data.weather && data.weather.current_weather) {
                    const w = data.weather.current_weather;
                    const weatherEl = document.getElementById('weather-display');
                    weatherEl.classList.remove('hidden');
                    weatherEl.innerHTML = `
                        <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Hamburg</span>
                        <span class="text-sm font-black text-blue-400 tracking-tight">${w.temperature}Â°C</span>
                        <div class="w-px h-3 bg-white/10 mx-1"></div>
                        <span class="text-[10px] text-slate-500 font-bold">${w.windspeed}km/h</span>
                    `;
                }

                updateCharts(data.strava.weeklyStats, loadData);
                document.getElementById('last-updated').textContent = 'Updated: ' + new Date().toLocaleTimeString();
            } catch (e) {
                console.error('Fetch error:', e);
            }
        }

        function updateCharts(stats, loadData) {
            const ctx1 = document.getElementById('activity-chart').getContext('2d');
            const types = Object.keys(stats.byType);
            if (activityChart) activityChart.destroy();
            activityChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: types,
                    datasets: [{
                        label: 'Distance (km)',
                        data: types.map(t => stats.byType[t].distance),
                        backgroundColor: 'rgba(59, 130, 246, 0.4)',
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 2,
                        borderRadius: 4,
                        hoverBackgroundColor: 'rgba(59, 130, 246, 0.6)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false },
                            ticks: { color: '#475569', font: { size: 10, weight: '700' } }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#475569', font: { size: 10, weight: '700' }, uppercase: true }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            const ctx2 = document.getElementById('load-history-chart').getContext('2d');
            if (loadHistoryChart) loadHistoryChart.destroy();
            
            const loadLabels = loadData.daily_stats.map(s => s.date.split('-').slice(1).join('/'));
            const loadValues = loadData.daily_stats.map(s => s.duration_h);

            loadHistoryChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: loadLabels,
                    datasets: [{
                        label: 'Duration (h)',
                        data: loadValues,
                        borderColor: '#8b5cf6',
                        backgroundColor: (context) => {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                            gradient.addColorStop(0, 'rgba(139, 92, 246, 0.2)');
                            gradient.addColorStop(1, 'rgba(139, 92, 246, 0)');
                            return gradient;
                        },
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 0,
                        pointHitRadius: 10,
                        pointHoverRadius: 5,
                        pointHoverBackgroundColor: '#8b5cf6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false },
                            ticks: { color: '#475569', font: { size: 10, weight: '700' } }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#475569', font: { size: 10, weight: '700' } }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        updateCountdown();
        refreshData();
        setInterval(updateCountdown, 60000);
        setInterval(refreshData, 300000);
    </script>
</body>
</html>
